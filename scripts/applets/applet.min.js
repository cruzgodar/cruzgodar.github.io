import{showZoomCard}from"../src/cards.min.js";import{addHoverEventWithScale}from"../src/hoverEvents.min.js";import{$,$$,addTemporaryListener,pageElement}from"../src/main.min.js";import{siteSettings}from"../src/settings.min.js";import{WilsonCPU,WilsonGPU}from"../wilson.min.js";const randomGlslFunctions={cadd:["vec2","vec2","vec2"],csub:["vec2","vec2","vec2"],cmul:["vec2","vec2","vec2"],cdiv:["vec2","vec2","vec2"],cexp:["vec2","vec2"],csin:["vec2","vec2"],ccos:["vec2","vec2"]};let currentlyLoadedApplets=[];function clearCurrentlyLoadedApplets(){currentlyLoadedApplets=[]}class Applet{canvas;wilson;wilsonForFullscreen;wilsonsForReduceMotion=[];allowFullscreenWithKeyboard=!0;fpsDisplayCtx;workers=[];timeoutIds=[];keysPressed={};numTouches=0;needNewFrame=!1;constructor(canvas){if(this.canvas=canvas,window.DEBUG&&setTimeout(()=>this.addFpsDisplay(),500),$("#applet-controls-card")&&!this.addHelpButton()){const e=setInterval(()=>{this.addHelpButton()&&clearInterval(e)},50)}this.addHoverEventOnFullscreenButton(),currentlyLoadedApplets.push(this)}destroy(){this.animationPaused=!0,this.workers.forEach(worker=>{worker?.terminate&&worker?.terminate()}),this.timeoutIds.forEach(timeoutId=>{null!=timeoutId&&clearTimeout(timeoutId)}),this.hiddenCanvasContainer&&this.hiddenCanvasContainer.remove(),this.wilson&&this.wilson.destroy();var e=["a","e","i","o","u","y"].includes(this.constructor.name[0].toLowerCase())?"n":"";console.log(`Destroyed a${e} ${this.constructor.name} applet`)}runWhenOnscreen(data){let a=!1;var e=()=>{var e,t;a||(t=(e=this.canvas.getBoundingClientRect()).top,-e.height<=t&&t<window.innerHeight&&(a=!0,setTimeout(()=>this.run(data),250)))};addTemporaryListener({object:window,event:"scroll",callback:e}),e()}addFpsDisplay(){var e=document.createElement("canvas");e.classList.add("fps-canvas"),e.setAttribute("width","100"),e.setAttribute("height","100"),this.canvas.parentNode.insertBefore(e,this.canvas.nextElementSibling),this.fpsDisplayCtx=e.getContext("2d"),requestAnimationFrame(this.updateFpsDisplay.bind(this))}lastFpsDisplayTimestamp;fpsTimestampHistory=new Array(100);updateFpsDisplay(timestamp){var t=timestamp-this.lastFpsDisplayTimestamp;if(t&&this.lastFpsDisplayTimestamp){this.lastFpsDisplayTimestamp=timestamp,this.fpsTimestampHistory.push(t),this.fpsTimestampHistory.shift(),this.fpsDisplayCtx.clearRect(0,0,100,100);for(let e=0;e<100;e++){const n=Math.min(this.fpsTimestampHistory[e],100);var a=hsvToRgb(n<8.333?5/9-n/8.333*(5/9-1/3):n<16.667?1/3-(n-8.333)/(16.667-8.333)*(1/3-7/45):n<33.333?7/45-(n-16.667)/(33.333-16.667)*(7/45-1/12):1/12-(n-33.333)/66.667*1/12,1,1);this.fpsDisplayCtx.fillStyle=`rgb(${a[0]}, ${a[1]}, ${a[2]})`,this.fpsDisplayCtx.fillRect(e,100-n,1,n)}this.fpsDisplayCtx.fillStyle="rgb(127, 127, 127)",this.fpsDisplayCtx.fillRect(0,91.667,100,2),this.fpsDisplayCtx.fillRect(0,83.333,100,2),this.fpsDisplayCtx.fillRect(0,66.667,100,2)}else this.lastFpsDisplayTimestamp=timestamp;requestAnimationFrame(this.updateFpsDisplay.bind(this))}hiddenCanvasContainer;createHiddenCanvas(hidden=!0){var e=document.createElement("canvas");return e.classList.add(hidden?"hidden-canvas":"output-canvas"),this.hiddenCanvasContainer||(this.hiddenCanvasContainer=document.createElement("div"),hidden&&(this.hiddenCanvasContainer.style.display="none"),pageElement.appendChild(this.hiddenCanvasContainer)),this.hiddenCanvasContainer.appendChild(e),e}addHoverEventOnFullscreenButton(){let t=0;const a=setInterval(()=>{if(!(40<t)&&(t++,this.wilsonsForReduceMotion=Object.values(this).filter(field=>field instanceof WilsonCPU||field instanceof WilsonGPU),0!==this.wilsonsForReduceMotion.length)){clearInterval(a);for(const e of this.wilsonsForReduceMotion)e.reduceMotion=siteSettings.reduceMotion}},50)}setReduceMotionOnWilsons(){let a=0;const n=setInterval(()=>{if(!(40<a)){a++;var e=$$(".WILSON_enter-fullscreen-button, .WILSON_exit-fullscreen-button");for(const t of e)addHoverEventWithScale({element:t,scale:1.1,addBounceOnTouch:()=>!0});0!==e.length&&clearInterval(n)}},50)}addHelpButton(){var e=this.wilson?.canvas?.parentElement;if(!e)return null;const t=document.createElement("div");return t.classList.add("wilson-help-button"),t.innerHTML=`
			<img src="/graphics/general-icons/help.webp" alt="Help" tabindex="0"></img>
		`,e.appendChild(t),setTimeout(()=>{addHoverEventWithScale({element:t,scale:1.1,addBounceOnTouch:()=>!0}),t.addEventListener("click",()=>showZoomCard({id:"applet-controls",fromElement:t}))},10),t}handleTouchstart(e){this.numTouches=e.touches.length}handleTouchend(e){3<=this.numTouches&&2===e.touches.length?this.numTouches=1:this.numTouches=e.touches.length}listenForKeysPressed(keys,callback=()=>{}){keys.forEach(key=>this.keysPressed[key]=!1),addTemporaryListener({object:document.documentElement,event:"keydown",callback:(function(e){var t;"INPUT"!==document.activeElement.tagName&&"TEXTAREA"!==document.activeElement.tagName&&(t=e.key.toLowerCase(),Object.prototype.hasOwnProperty.call(this.keysPressed,t))&&(e.preventDefault(),this.keysPressed[t]||(this.keysPressed[t]=!0,callback(t,!0)))}).bind(this)}),addTemporaryListener({object:document.documentElement,event:"keyup",callback:(function(e){var t=e.key.toLowerCase();Object.prototype.hasOwnProperty.call(this.keysPressed,t)&&(e.preventDefault(),this.keysPressed[t])&&(this.keysPressed[t]=!1,callback(t,!1))}).bind(this)})}listenForNumTouches(){addTemporaryListener({object:this.canvas.parentNode.nextElementSibling,event:"touchstart",callback:this.handleTouchStartEvent.bind(this)}),addTemporaryListener({object:this.canvas.parentNode.nextElementSibling,event:"touchend",callback:this.handleTouchEndEvent.bind(this)})}}function hsvToRgb(h,s,v){function e(n){var e=(n+6*h)%6;return v-v*s*Math.max(0,Math.min(e,Math.min(4-e,1)))}return[255*e(5),255*e(3),255*e(1)]}function getMinGlslString(varName,numVars,functionName="min"){var e=Math.ceil(Math.log2(numVars));let t=new Array(numVars);for(let n=0;n<numVars;n++)t[n]=""+varName+(n+1);for(let r=0;r<e;r++){var a=new Array(Math.ceil(t.length/2));for(let e=0;e<t.length;e+=2)a[e/2]=`${functionName}(${t[e]}, ${t[e+1]})`;t.length%2==1&&(a[a.length-1]=t[t.length-1]),t=a}return t[0]}function getMaxGlslString(varName,numVars){return getMinGlslString(varName,numVars,"max")}function getColorGlslString(varName,minVarName,colors){let e="";for(let t=0;t<colors.length;t++)e+=`if (${minVarName} == ${varName}${t+1}) { return vec3(${colors[t][0]/255}, ${colors[t][1]/255}, ${colors[t][2]/255}); }
		`;return e}function getFloatGlsl(float){return"string"==typeof float||float!==Math.floor(float)?float:`float(${float})`}function getVectorGlsl(vector){return 2===vector.length?`vec2(${vector[0]}, ${vector[1]})`:3===vector.length?`vec3(${vector[0]}, ${vector[1]}, ${vector[2]})`:4===vector.length?`vec4(${vector[0]}, ${vector[1]}, ${vector[2]}, ${vector[3]})`:(console.error("Invalid vector length!"),"")}function getMatrixGlsl(matrix){return 2===matrix.length?`mat2(
			${matrix[0][0]}, ${matrix[1][0]},
			${matrix[0][1]}, ${matrix[1][1]}
		)`:3===matrix.length?`mat3(
			${matrix[0][0]}, ${matrix[1][0]}, ${matrix[2][0]},
			${matrix[0][1]}, ${matrix[1][1]}, ${matrix[2][1]},
			${matrix[0][2]}, ${matrix[1][2]}, ${matrix[2][2]}
		)`:4===matrix.length?`mat4(
			${matrix[0][0]}, ${matrix[1][0]}, ${matrix[2][0]}, ${matrix[3][0]},
			${matrix[0][1]}, ${matrix[1][1]}, ${matrix[2][1]}, ${matrix[3][1]},
			${matrix[0][2]}, ${matrix[1][2]}, ${matrix[2][2]}, ${matrix[3][2]},
			${matrix[0][3]}, ${matrix[1][3]}, ${matrix[2][3]}, ${matrix[3][3]}
		)`:(console.error("Invalid matrix shape!"),"")}function doubleToDf(d){var e=new Float32Array(2),t=536870913*d,t=t-(t-d),a=d-t;return e[0]=t,e[1]=a,[e[0],e[1]]}function hexToRgb(hex){var e=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);return e?{r:parseInt(e[1],16),g:parseInt(e[2],16),b:parseInt(e[3],16)}:null}function componentToHex(c){var e=Math.floor(c).toString(16);return 1==e.length?"0"+e:e}function rgbToHex(r,g,b){return"#"+componentToHex(r)+componentToHex(g)+componentToHex(b)}function parseNaturalGlsl(glsl){let e=glsl.replaceAll(/\s/g,"");for(;e.match(/([^.0-9])([0-9]+)([^.0-9])/g);)e=e.replaceAll(/([^.0-9])([0-9]+)([^.0-9])/g,(match,$1,$2,$3)=>""+$1+$2+".0"+$3);for(e=e.replaceAll(/([^0-9])(\.[0-9])/g,(match,$1,$2)=>$1+"0"+$2).replaceAll(/([0-9]\.)([^0-9])/g,(match,$1,$2)=>$1+"0"+$2).replaceAll(/([0-9)])([a-z(])/g,(match,$1,$2)=>$1+" * "+$2);e.match(/([xyz])([xyz])/g);)e=e.replaceAll(/([xyz])([xyz])/g,(match,$1,$2)=>$1+" * "+$2);return e=e.replaceAll(/([a-z0-9.]+)\^([a-z0-9.]+)/g,(match,$1,$2)=>`pow(${$1}, ${$2})`),window.DEBUG&&console.log(e),e}function getRandomGlsl({depth=0,maxDepth,variables=[],returnType="vec2"}){var e;return(maxDepth=maxDepth||Math.floor(3*Math.random())+2)<=depth?Math.random()<.8?variables[Math.floor(Math.random()*variables.length)]:`vec2(${Math.random()<.99?variables[Math.floor(Math.random()*variables.length)]+"."+(Math.random()<.5?"x":"y"):""+Math.round(100*Math.random())/100}, ${Math.random()<.99?variables[Math.floor(Math.random()*variables.length)]+"."+(Math.random()<.5?"x":"y"):""+Math.round(100*Math.random())/100})`:`${e=(e=Object.keys(randomGlslFunctions).filter(key=>randomGlslFunctions[key][0]===returnType))[Math.floor(Math.random()*e.length)]}(${randomGlslFunctions[e].slice(1).map(type=>getRandomGlsl({depth:depth+1,maxDepth:maxDepth,variables:variables,returnType:type})).join(",")})`}const tempShader=`
	precision highp float;
	varying vec2 uv;
	
	void main(void)
	{
		gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);
	}
`;export{currentlyLoadedApplets,clearCurrentlyLoadedApplets,Applet,hsvToRgb,getMinGlslString,getMaxGlslString,getColorGlslString,getFloatGlsl,getVectorGlsl,getMatrixGlsl,doubleToDf,hexToRgb,rgbToHex,parseNaturalGlsl,getRandomGlsl,tempShader};