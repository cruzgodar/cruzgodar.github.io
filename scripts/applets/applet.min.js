import{convertColor}from"../src/browser.min.js";import{openZoomCard}from"../src/cards.min.js";import{addHoverEventWithScale}from"../src/hoverEvents.min.js";import{$,$$,addTemporaryListener}from"../src/main.min.js";import{siteSettings}from"../src/settings.min.js";import{WilsonCPU,WilsonGL}from"../wilson.min.js";const randomGlslFunctions={cadd:["vec2","vec2","vec2"],csub:["vec2","vec2","vec2"],cmul:["vec2","vec2","vec2"],cdiv:["vec2","vec2","vec2"],cexp:["vec2","vec2"],csin:["vec2","vec2"],ccos:["vec2","vec2"]};let currentlyLoadedApplets=[];function clearCurrentlyLoadedApplets(){currentlyLoadedApplets=[]}class Applet{canvas;wilson;wilsonForFullscreen;wilsonForReset;wilsons=[];allowFullscreenWithKeyboard=!0;allowResetWithKeyboard=!0;fpsDisplayCtx;workers=[];timeoutIds=[];keysPressed={};numTouches=0;needNewFrame=!1;constructor(canvas){if(this.canvas=canvas,window.DEBUG&&setTimeout(()=>this.addFpsDisplay(),500),$("#applet-controls-card")&&!this.addHelpButton()){const t=setInterval(()=>{this.addHelpButton()&&clearInterval(t)},50)}this.addHoverEventOnWilsonButtons(),this.setReduceMotionOnWilsons(),currentlyLoadedApplets.push(this)}destroy(){this.animationPaused=!0;for(const e of this.workers)e?.terminate&&e.terminate();for(const a of this.timeoutIds)null!=a&&clearTimeout(a);this.hiddenCanvasContainer&&this.hiddenCanvasContainer.remove();for(const r of this.wilsons)r.destroy();var t=["a","e","i","o","u","y"].includes(this.constructor.name[0].toLowerCase())?"n":"";window.DEBUG&&console.log(`Destroyed a${t} ${this.constructor.name} applet`)}runWhenOnscreen(data){let a=!1;var t=()=>{var t,e;a||(e=(t=this.canvas.getBoundingClientRect()).top,-t.height<=e&&e<window.innerHeight&&(a=!0,setTimeout(()=>this.run(data),250)))};addTemporaryListener({object:window,event:"scroll",callback:t}),t()}addFpsDisplay(){var t=document.createElement("canvas");t.classList.add("fps-canvas"),t.setAttribute("width","100"),t.setAttribute("height","100"),this.canvas.parentNode.insertBefore(t,this.canvas.nextElementSibling),this.fpsDisplayCtx=t.getContext("2d"),t.style.setProperty("view-transition-name","fps-canvas"+Math.random().toString(36).slice(2)),requestAnimationFrame(this.updateFpsDisplay.bind(this))}lastFpsDisplayTimestamp;fpsTimestampHistory=new Array(100);updateFpsDisplay(timestamp){var e=timestamp-this.lastFpsDisplayTimestamp;if(e&&this.lastFpsDisplayTimestamp){this.lastFpsDisplayTimestamp=timestamp,this.fpsTimestampHistory.push(e),this.fpsTimestampHistory.shift(),this.fpsDisplayCtx.clearRect(0,0,100,100);for(let t=0;t<100;t++){const r=Math.min(this.fpsTimestampHistory[t],100);var a=hsvToRgb(r<8.333?5/9-r/8.333*(5/9-1/3):r<16.667?1/3-(r-8.333)/(16.667-8.333)*(1/3-7/45):r<33.333?7/45-(r-16.667)/(33.333-16.667)*(7/45-1/12):1/12-(r-33.333)/66.667*1/12,1,1);this.fpsDisplayCtx.fillStyle=convertColor(...a),this.fpsDisplayCtx.fillRect(t,100-r,1,r)}this.fpsDisplayCtx.fillStyle="rgb(127, 127, 127)",this.fpsDisplayCtx.fillRect(0,91.667,100,2),this.fpsDisplayCtx.fillRect(0,83.333,100,2),this.fpsDisplayCtx.fillRect(0,66.667,100,2)}else this.lastFpsDisplayTimestamp=timestamp;requestAnimationFrame(this.updateFpsDisplay.bind(this))}hiddenCanvasContainer;createHiddenCanvas(hidden=!0,aspectRatio=1){var t=document.createElement("canvas");return t.classList.add(hidden?"hidden-canvas":"output-canvas"),t.style.width="10px",t.style.height=10/aspectRatio+"px",this.hiddenCanvasContainer||(this.hiddenCanvasContainer=document.createElement("div"),this.hiddenCanvasContainer.classList.add("temporary-element"),this.hiddenCanvasContainer.style.position="fixed",this.hiddenCanvasContainer.style.top="0",this.hiddenCanvasContainer.style.left="calc(-1000vw - 100px)",document.body.appendChild(this.hiddenCanvasContainer)),this.hiddenCanvasContainer.appendChild(t),t}addHoverEventOnWilsonButtons(){let a=0;const r=setInterval(()=>{if(!(40<a)){a++;var t=$$(`
				.WILSON_enter-fullscreen-button,
				.WILSON_exit-fullscreen-button,
				.WILSON_reset-button
			`);for(const e of t)addHoverEventWithScale({element:e,scale:1.1,addBounceOnTouch:()=>!0});0!==t.length&&clearInterval(r)}},50)}setReduceMotionOnWilsons(){let e=0;const a=setInterval(()=>{if(!(40<e)&&(e++,this.wilsons=Object.values(this).filter(field=>field instanceof WilsonCPU||field instanceof WilsonGL),0!==this.wilsons.length)){clearInterval(a);for(const t of this.wilsons)t.reduceMotion=siteSettings.reduceMotion}},50)}addHelpButton(){var t=this.wilson?.canvas?.parentElement;if(!t)return null;const e=document.createElement("div");return e.classList.add("wilson-help-button"),e.innerHTML=`
			<img src="/graphics/general-icons/help.webp" alt="Help" tabindex="0"></img>
		`,t.appendChild(e),setTimeout(()=>{addHoverEventWithScale({element:e,scale:1.1,addBounceOnTouch:()=>!0}),e.addEventListener("click",()=>openZoomCard({id:"applet-controls",fromElement:e})),siteSettings.reduceMotion||e.style.setProperty("view-transition-name","wilson-help-button"+Math.random().toString(36).slice(2))},10),e}handleTouchstart(e){this.numTouches=e.touches.length}handleTouchend(e){3<=this.numTouches&&2===e.touches.length?this.numTouches=1:this.numTouches=e.touches.length}listenForKeysPressed(keys,callback=()=>{}){for(const t of keys)this.keysPressed[t]=!1;addTemporaryListener({object:document.documentElement,event:"keydown",callback:(function(e){var t;"INPUT"!==document.activeElement.tagName&&"TEXTAREA"!==document.activeElement.tagName&&(t=e.key.toLowerCase(),Object.prototype.hasOwnProperty.call(this.keysPressed,t))&&(e.preventDefault(),this.keysPressed[t]||(this.keysPressed[t]=!0,callback(t,!0)))}).bind(this)}),addTemporaryListener({object:document.documentElement,event:"keyup",callback:(function(e){var t=e.key.toLowerCase();Object.prototype.hasOwnProperty.call(this.keysPressed,t)&&(e.preventDefault(),this.keysPressed[t])&&(this.keysPressed[t]=!1,callback(t,!1))}).bind(this)})}listenForNumTouches(){addTemporaryListener({object:this.canvas.parentNode.nextElementSibling,event:"touchstart",callback:this.handleTouchStartEvent.bind(this)}),addTemporaryListener({object:this.canvas.parentNode.nextElementSibling,event:"touchend",callback:this.handleTouchEndEvent.bind(this)})}downloadBokehFrameFromPixels({pixels,resolution,blurAmount=1,clipDistance}){var t=resolution/250*blurAmount,e=this.createHiddenCanvas(),a={canvasWidth:resolution,verbose:window.DEBUG},a=new WilsonCPU(e,a),r=(a.ctx.fillStyle="rgb(0, 0, 0)",a.ctx.fillRect(0,0,resolution,resolution),new Array(resolution*resolution));for(let y=0;y<resolution*resolution;y++){var n=y%resolution,o=Math.floor(y/resolution);r[y]=[pixels[4*y+3],n,o,255*pixels[4*y],255*pixels[4*y+1],255*pixels[4*y+2]]}var s=r.sort((a,b)=>b[0]-a[0]),i=s[s.length-1][0];let l=0;for(let b=0;b<s.length;b++)if(s[b][0]<clipDistance){l=b;break}var c=s[l=Math.floor(l+.1*(s.length-l))][0],m=new Array(resolution*resolution*4).fill(0);for(const M of s){var h=M[0];if(h!==clipDistance){var d,p=M[1],v=M[2],u=Math.min(Math.max((h-i)/(c-i),0),1)*(t-.5)+.5;let e=0;for(let a=Math.floor(-u);a<=Math.ceil(u);a++)for(let t=Math.floor(-u);t<=Math.ceil(u);t++)t*t+a*a<=u*u&&(d=Math.min(u-Math.sqrt(t*t+a*a),1),e+=d);var f,g,x=1/e;for(let r=Math.floor(-u);r<=Math.ceil(u);r++)for(let t=Math.floor(-u);t<=Math.ceil(u);t++)t*t+r*r<=u*u&&(f=v+r,g=p+t,f<0||resolution<=f||g<0||resolution<=g||(f=f*resolution+g,g=x*Math.min(u-Math.sqrt(t*t+r*r),1),m[4*f]+=M[3]*g,m[4*f+1]+=M[4]*g,m[4*f+2]+=M[5]*g))}}var $=new Uint8ClampedArray(m);for(let w=0;w<resolution*resolution;w++)$[4*w+3]=255;a.drawFrame($),a.downloadFrame("bokeh-render.png"),e.remove()}}function hsvToRgb(h,s,v){function t(n){var t=(n+6*h)%6;return v-v*s*Math.max(0,Math.min(t,Math.min(4-t,1)))}return[255*t(5),255*t(3),255*t(1)]}function rgbToHsv(r,g,b){r/=255,g/=255,b/=255;var t=Math.max(r,g,b),e=t-Math.min(r,g,b);let a=0;return 0!=e&&(a=t===r?((g-b)/e+6)%6:t===g?(b-r)/e+2:(r-g)/e+4,a/=6),[a,0===t?0:e/t,t]}function getMinGlslString(varName,numVars,functionName="min"){var t=Math.ceil(Math.log2(numVars));let e=new Array(numVars);for(let r=0;r<numVars;r++)e[r]=""+varName+(r+1);for(let n=0;n<t;n++){var a=new Array(Math.ceil(e.length/2));for(let t=0;t<e.length;t+=2)a[t/2]=`${functionName}(${e[t]}, ${e[t+1]})`;e.length%2==1&&(a[a.length-1]=e[e.length-1]),e=a}return e[0]}function getMaxGlslString(varName,numVars){return getMinGlslString(varName,numVars,"max")}function getColorGlslString(varName,minVarName,colors){let t="";for(let e=0;e<colors.length;e++)t+=`if (${minVarName} == ${varName}${e+1}) { return vec3(${colors[e][0]/255}, ${colors[e][1]/255}, ${colors[e][2]/255}); }
		`;return t}function getFloatGlsl(float){return"string"==typeof float||float!==Math.floor(float)?float:`float(${float})`}function getFloatWgsl(float){return"string"==typeof float||float!==Math.floor(float)?float:`f32(${float})`}function getVectorGlsl(vector){return 2===vector.length?`vec2(${vector[0]}, ${vector[1]})`:3===vector.length?`vec3(${vector[0]}, ${vector[1]}, ${vector[2]})`:4===vector.length?`vec4(${vector[0]}, ${vector[1]}, ${vector[2]}, ${vector[3]})`:(console.error("Invalid vector length!"),"")}function getVectorWgsl(vector){return 2===vector.length?`vec2<f32>(${vector[0]}, ${vector[1]})`:3===vector.length?`vec3<f32>(${vector[0]}, ${vector[1]}, ${vector[2]})`:4===vector.length?`vec4<f32>(${vector[0]}, ${vector[1]}, ${vector[2]}, ${vector[3]})`:(console.error("Invalid vector length!"),"")}function getMatrixGlsl(matrix){return 2===matrix.length?`mat2(
			${matrix[0][0]}, ${matrix[1][0]},
			${matrix[0][1]}, ${matrix[1][1]}
		)`:3===matrix.length?`mat3(
			${matrix[0][0]}, ${matrix[1][0]}, ${matrix[2][0]},
			${matrix[0][1]}, ${matrix[1][1]}, ${matrix[2][1]},
			${matrix[0][2]}, ${matrix[1][2]}, ${matrix[2][2]}
		)`:4===matrix.length?`mat4(
			${matrix[0][0]}, ${matrix[1][0]}, ${matrix[2][0]}, ${matrix[3][0]},
			${matrix[0][1]}, ${matrix[1][1]}, ${matrix[2][1]}, ${matrix[3][1]},
			${matrix[0][2]}, ${matrix[1][2]}, ${matrix[2][2]}, ${matrix[3][2]},
			${matrix[0][3]}, ${matrix[1][3]}, ${matrix[2][3]}, ${matrix[3][3]}
		)`:(console.error("Invalid matrix shape!"),"")}function getMatrixWgsl(matrix){return 2===matrix.length?`mat2x2<f32>(
			${matrix[0][0]}, ${matrix[1][0]},
			${matrix[0][1]}, ${matrix[1][1]}
		)`:3===matrix.length?`mat3x3<f32>(
			${matrix[0][0]}, ${matrix[1][0]}, ${matrix[2][0]},
			${matrix[0][1]}, ${matrix[1][1]}, ${matrix[2][1]},
			${matrix[0][2]}, ${matrix[1][2]}, ${matrix[2][2]}
		)`:4===matrix.length?`mat4x4<f32>(
			${matrix[0][0]}, ${matrix[1][0]}, ${matrix[2][0]}, ${matrix[3][0]},
			${matrix[0][1]}, ${matrix[1][1]}, ${matrix[2][1]}, ${matrix[3][1]},
			${matrix[0][2]}, ${matrix[1][2]}, ${matrix[2][2]}, ${matrix[3][2]},
			${matrix[0][3]}, ${matrix[1][3]}, ${matrix[2][3]}, ${matrix[3][3]}
		)`:(console.error("Invalid matrix shape!"),"")}function doubleToDf(d){var t=new Float32Array(2),e=536870913*d,e=e-(e-d),a=d-e;return t[0]=e,t[1]=a,[t[0],t[1]]}function hexToRgb(hex){var t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);return t?[parseInt(t[1],16),parseInt(t[2],16),parseInt(t[3],16)]:null}function componentToHex(c){var t=Math.floor(c).toString(16);return 1==t.length?"0"+t:t}function rgbToHex(r,g,b){return"#"+componentToHex(r)+componentToHex(g)+componentToHex(b)}function parseNaturalGlsl(glsl){let t=glsl.replaceAll(/\s/g,"");for(;t.match(/([^.0-9])([0-9]+)([^.0-9])/g);)t=t.replaceAll(/([^.0-9])([0-9]+)([^.0-9])/g,(match,$1,$2,$3)=>""+$1+$2+".0"+$3);for(t=t.replaceAll(/([^0-9])(\.[0-9])/g,(match,$1,$2)=>$1+"0"+$2).replaceAll(/([0-9]\.)([^0-9])/g,(match,$1,$2)=>$1+"0"+$2).replaceAll(/([0-9)])([a-z(])/g,(match,$1,$2)=>$1+" * "+$2);t.match(/([xyz])([xyz])/g);)t=t.replaceAll(/([xyz])([xyz])/g,(match,$1,$2)=>$1+" * "+$2);return t=t.replaceAll(/([a-z0-9.]+)\^([a-z0-9.]+)/g,(match,$1,$2)=>`pow(${$1}, ${$2})`),window.DEBUG&&console.log(t),t}function getRandomGlsl({depth=0,maxDepth,variables=[],returnType="vec2"}){var t;return(maxDepth=maxDepth||Math.floor(3*Math.random())+2)<=depth?Math.random()<.8?variables[Math.floor(Math.random()*variables.length)]:`vec2(${Math.random()<.99?variables[Math.floor(Math.random()*variables.length)]+"."+(Math.random()<.5?"x":"y"):""+Math.round(100*Math.random())/100}, ${Math.random()<.99?variables[Math.floor(Math.random()*variables.length)]+"."+(Math.random()<.5?"x":"y"):""+Math.round(100*Math.random())/100})`:`${t=(t=Object.keys(randomGlslFunctions).filter(key=>randomGlslFunctions[key][0]===returnType))[Math.floor(Math.random()*t.length)]}(${randomGlslFunctions[t].slice(1).map(type=>getRandomGlsl({depth:depth+1,maxDepth:maxDepth,variables:variables,returnType:type})).join(",")})`}const tempShader=`
	precision highp float;
	varying vec2 uv;
	
	void main(void)
	{
		gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);
	}
`;export{currentlyLoadedApplets,clearCurrentlyLoadedApplets,Applet,hsvToRgb,rgbToHsv,getMinGlslString,getMaxGlslString,getColorGlslString,getFloatGlsl,getFloatWgsl,getVectorGlsl,getVectorWgsl,getMatrixGlsl,getMatrixWgsl,doubleToDf,hexToRgb,rgbToHex,parseNaturalGlsl,getRandomGlsl,tempShader};