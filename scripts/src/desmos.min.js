import{changeOpacity}from"./animation.min.js";import{addTemporaryListener,loadScript,raw}from"./main.min.js";import{siteSettings}from"./settings.min.js";import{clamp}from"./utils.min.js";const desmosPurple="_desmosPurple",desmosBlue="_desmosBlue",desmosRed="_desmosRed",desmosOrange="_desmosOrange",desmosBlack="_desmosBlack",desmosGray="_desmosGray",functionsForColors={[desmosPurple]:(is3d,alwaysDark,highContrast)=>is3d?siteSettings.increaseContrast||highContrast?"#7f00ff":"#7f32cc":siteSettings.increaseContrast||highContrast?siteSettings.darkTheme||alwaysDark?"#3f7f00":"#7f32cc":siteSettings.darkTheme||alwaysDark?"#66cc00":"#7f32cc",[desmosBlue]:(is3d,alwaysDark,highContrast)=>is3d?siteSettings.increaseContrast||highContrast?"#007fff":"#327fcc":siteSettings.increaseContrast||highContrast?siteSettings.darkTheme||alwaysDark?"#7f3f00":"#327fcc":siteSettings.darkTheme||alwaysDark?"#cc6600":"#327fcc",[desmosRed]:(is3d,alwaysDark,highContrast)=>is3d?siteSettings.increaseContrast||highContrast?"#ff0000":"#cc3232":siteSettings.increaseContrast||highContrast?siteSettings.darkTheme||alwaysDark?"#007f7f":"#cc3232":siteSettings.darkTheme||alwaysDark?"#00cccc":"#cc3232",[desmosOrange]:(is3d,alwaysDark,highContrast)=>is3d?siteSettings.increaseContrast||highContrast?"#ff7f00":"#cc7f32":siteSettings.increaseContrast||highContrast?siteSettings.darkTheme||alwaysDark?"#003f7f":"#cc7f32":siteSettings.darkTheme||alwaysDark?"#0066cc":"#cc7f32",[desmosBlack]:is3d=>{if(is3d)throw new Error("desmosBlack is not a valid color for 3d graphs");return"#000000"},[desmosGray]:is3d=>{if(is3d)return"#777777";throw new Error("desmosGray is not a valid color for 2d graphs")}};let desmosGraphs={},desmosGraphsDefaultState={},desmosGraphsLoaded={},desmosGraphResolves={};function clearDesmosGraphs(){desmosGraphs={},desmosGraphsDefaultState={},desmosGraphsLoaded={},desmosGraphResolves={}}let desmosGraphsConstructorData={},desmosGraphConstructionStack=[];const desmosGraphConstructionCooldownTime=750;let desmosGraphConstructionCooldown=Promise.resolve(),desmosData={};async function createDesmosGraphs(desmosDataInitializer=desmosData,recreating=!1){if(!window.OFFLINE){for(const t in desmosGraphs)desmosGraphs[t]?.destroy&&(desmosGraphs[t].destroy(),delete desmosGraphs[t],delete desmosGraphsDefaultState[t],delete desmosGraphsLoaded[t],delete desmosGraphResolves[t]);desmosData=desmosDataInitializer,desmosGraphsConstructorData={},desmosGraphConstructionStack=[],desmosGraphConstructionCooldown=Promise.resolve();const r=structuredClone(desmosData);for(const a in r){var s=r[a].use3d;for(const i of r[a].expressions)i.color&&functionsForColors[i.color]&&(i.color=functionsForColors[i.color](s,r[a].alwaysDark,r[a].highContrast)),i.latex&&(i.latex=i.latex.replace(/\(/g,raw`\left(`),i.latex=i.latex.replace(/\)/g,raw`\right)`),i.latex=i.latex.replace(/\[/g,raw`\left[`),i.latex=i.latex.replace(/\]/g,raw`\right]`),i.latex=i.latex.replace(/([^\\left])\\\{/g,(match,$1)=>raw`${$1}\left\{`),i.latex=i.latex.replace(/([^\\right])\\\}/g,(match,$1)=>raw`${$1}\right\}`),s||(i.lineWidth??=3.5))}var o=document.body.querySelectorAll(".desmos-container");for(const n of o)desmosGraphsLoaded[n.id]=new Promise(resolve=>{desmosGraphResolves[n.id]=resolve});await loadScript("/scripts/desmos.min.js");for(const d of o){let e=!1;for(const m of r[d.id].expressions)if(!m.secret){e=!0;break}const l={keypad:!1,settingsMenu:!1,zoomButtons:!1,showResetButtonOnGraphpaper:!0,border:!1,expressionsCollapsed:!0,invertedColors:siteSettings.darkTheme||r[d.id].alwaysDark,xAxisMinorSubdivisions:1,yAxisMinorSubdivisions:1,expressions:e,colors:{PURPLE:functionsForColors[desmosPurple](r[d.id].use3d,r[d.id].alwaysDark,r[d.id].highContrast),BLUE:functionsForColors[desmosBlue](r[d.id].use3d,r[d.id].alwaysDark,r[d.id].highContrast),RED:functionsForColors[desmosRed](r[d.id].use3d,r[d.id].alwaysDark,r[d.id].highContrast),ORANGE:functionsForColors[desmosOrange](r[d.id].use3d,r[d.id].alwaysDark,r[d.id].highContrast),...r[d.id].use3d?{BLACK:functionsForColors[desmosGray](r[d.id].use3d)}:{BLACK:functionsForColors[desmosBlack](r[d.id].use3d)}},...r[d.id].options??{}},c=r[d.id].use3d?Desmos.Calculator3D:Desmos.GraphingCalculator;desmosGraphsConstructorData[d.id]={element:d,constructor:()=>{desmosGraphs[d.id]=c(d,l),console.log("Desmos graph created");var e,s,o=r[d.id].bounds,t=d.getBoundingClientRect(),t=t.width/t.height;void 0===o.xmin&&void 0!==o.left&&(o.xmin=o.left,delete o.left),void 0===o.xmax&&void 0!==o.right&&(o.xmax=o.right,delete o.right),void 0===o.ymin&&void 0!==o.bottom&&(o.ymin=o.bottom,delete o.bottom),void 0===o.ymax&&void 0!==o.top&&(o.ymax=o.top,delete o.top),void 0!==l.showPlane3D&&(desmosGraphs[d.id].controller.graphSettings.showPlane3D=l.showPlane3D),r[d.id].use3d||(e=o.xmax-o.xmin,s=(o.xmin+o.xmax)/2,o.xmin=s-e/2*t,o.xmax=s+e/2*t),desmosGraphs[d.id].setMathBounds(o),desmosGraphs[d.id].setExpressions(r[d.id].expressions),desmosGraphs[d.id].controller.graphSettings.showBox3D=!1,desmosGraphs[d.id].updateSettings({}),desmosGraphsDefaultState[d.id]=desmosGraphs[d.id].getState(),desmosGraphs[d.id].setDefaultState(desmosGraphsDefaultState[d.id]),window.DEBUG&&!recreating&&d.addEventListener("click",e=>{e.metaKey&&getDesmosScreenshot(d.id,e.altKey)}),desmosGraphResolves[d.id]()},is3d:r[d.id].use3d}}addTemporaryListener({object:window,event:"scroll",callback:onScroll}),onScroll()}}function onScroll(){for(var[e,s]of Object.entries(desmosGraphsConstructorData)){var o=s.element.getBoundingClientRect(),t=o.top;t>=-o.height-window.innerHeight&&t<2*window.innerHeight&&(desmosGraphConstructionStack.push(s),1===desmosGraphConstructionStack.length&&handleDesmosGraphConstructionStack(),delete desmosGraphsConstructorData[e])}}async function handleDesmosGraphConstructionStack(){desmosGraphConstructionStack.length&&(await desmosGraphConstructionCooldown,desmosGraphConstructionStack.pop().constructor(),desmosGraphConstructionCooldown=new Promise(resolve=>{setTimeout(resolve,desmosGraphConstructionCooldownTime)}),handleDesmosGraphConstructionStack())}async function recreateDesmosGraphs(){var e=Array.from(document.body.querySelectorAll(".desmos-container"));e&&(await Promise.all(e.map(element=>changeOpacity({element:element,opacity:0}))),await createDesmosGraphs(desmosData,!0),await Promise.all(e.map(element=>changeOpacity({element:element,opacity:1}))))}async function getDesmosScreenshot(id,forPdf=!1){desmosGraphs[id].controller.graphSettings.showPlane3D=!1,desmosGraphs[id].controller.graphSettings.showNumbers3D=forPdf,desmosGraphs[id].controller.graphSettings.showAxisLabels3D=forPdf,desmosGraphs[id].updateSettings({showGrid:forPdf,xAxisNumbers:forPdf,yAxisNumbers:forPdf});var e=desmosGraphs[id].getState().graph.threeDMode;if(console.log(desmosGraphs[id].getExpressions()),!e){var s=desmosGraphs[id].getExpressions();for(let e=0;e<s.length;e++)s[e].lineWidth=forPdf?5:30,s[e].pointSize=forPdf?10:50,s[e].dragMode="NONE";desmosGraphs[id].setExpressions(s)}var e=e?desmosGraphs[id].screenshot({width:800,height:800,targetPixelRatio:4}):await new Promise(resolve=>{desmosGraphs[id].asyncScreenshot({width:800,height:800,targetPixelRatio:4,showLabels:forPdf},resolve)}),o=document.createElement("img");o.width=3600,o.height=3600,o.style.width="50vmin",o.style.height="50vmin",o.src=e,document.body.appendChild(o)}let uid=0;function getDesmosPoint({point,color,dragMode="XY",style="POINT",secret=!0,size=9}){return[{latex:raw`(${point[0]}, ${point[1]})`,dragMode:dragMode,pointStyle:style,color:color,secret:secret,pointSize:size}]}function getDesmosSlider({expression,min,max,step,playing=!1,secret=!0}){return[{latex:raw`${expression}`,sliderBounds:{min:min,max:max,step:step},playing:playing,secret:secret}]}function getDesmosVector({from,to,color,secret=!0,lineStyle="SOLID",arrowSize="0.35",lineWidth}){return uid++,[{latex:raw`((${from[0]}), (${from[1]})), ((${to[0]}), (${to[1]}))`,color:color,lines:!0,points:!1,secret:secret,lineStyle:lineStyle,lineWidth:lineWidth},{latex:raw`s_{${uid}} = \arctan(${to[1]} - (${from[1]}), ${to[0]} - (${from[0]}))`,secret:secret,lineWidth:lineWidth},{latex:raw`((${to[0]}), (${to[1]})), ((${to[0]}) - ${arrowSize}\cos(s_{${uid}} + .5), (${to[1]}) - ${arrowSize}\sin(s_{${uid}} + .5))`,color:color,lines:!0,points:!1,secret:secret,lineWidth:lineWidth},{latex:raw`((${to[0]}), (${to[1]})), ((${to[0]}) - ${arrowSize}\cos(s_{${uid}} - .5), (${to[1]}) - ${arrowSize}\sin(s_{${uid}} - .5))`,color:color,lines:!0,points:!1,secret:secret,lineWidth:lineWidth}]}function getDesmosBounds(desmosGraph){var e=desmosGraph.graphpaperBounds.mathCoordinates;return{xmin:e.xmin,xmax:e.xmax,ymin:e.ymin,ymax:e.ymax}}function getColoredParametricCurve({fieldFunction,pathFunction,pathFunctionDesmos,minT,maxT,numSlices,colorFunction}){return Array.from({length:numSlices},(_,i)=>{var e=(maxT-minT)/numSlices,s=minT+i*e,o=pathFunction(s),t=pathFunction(s+e),t=[(t[0]-o[0])/e,(t[1]-o[1])/e],r=Math.sqrt(t[0]*t[0]+t[1]*t[1]),t=[t[0]/r,t[1]/r],r=fieldFunction(o[0],o[1]),o=clamp(r[0]*t[0]+r[1]*t[1],-2,2)/2,r=colorFunction(o);return{latex:pathFunctionDesmos,parametricDomain:{min:s,max:s+e},color:r,lineWidth:5,secret:!0}})}export{desmosPurple,desmosBlue,desmosRed,desmosOrange,desmosBlack,desmosGray,desmosGraphs,desmosGraphsDefaultState,desmosGraphsLoaded,clearDesmosGraphs,createDesmosGraphs,recreateDesmosGraphs,getDesmosScreenshot,getDesmosPoint,getDesmosSlider,getDesmosVector,getDesmosBounds,getColoredParametricCurve};