import anime from"../anime.min.js";import{Checkbox}from"./checkboxes.min.js";import{addHoverEventWithScale}from"./hoverEvents.min.js";import{InputElement}from"./inputElement.min.js";import{$$,addTemporaryListener,pageElement}from"./main.min.js";import{siteSettings}from"./settings.min.js";let uncapEverything=!1;class TextBox extends InputElement{defaultValue;valueTypeIsString=!1;affectedByResMult=!1;constructor({element,name,value,maxValue=1/0,minValue=-1/0,onInput=()=>{},onEnter=()=>{}}){super({element:element,name:name}),this.value=value,this.defaultValue=this.value,this.onInput=onInput,this.onEnter=onEnter,this.maxValue=maxValue,this.minValue=minValue,this.element.value=this.value,this.element.nextElementSibling.textContent=this.name,"string"==typeof this.value&&(this.valueTypeIsString=!0),this.element.addEventListener("input",()=>this.inputCallback()),this.element.addEventListener("focusout",()=>{""===this.element.value&&(this.element.value=this.defaultValue,this.value=this.valueTypeIsString?this.element.value:parseFloat(this.element.value)),this.updateCaps()}),this.element.addEventListener("keydown",e=>{"Enter"!==e.key||this.disabled||(""===this.element.value&&(this.element.value=this.defaultValue,this.value=this.valueTypeIsString?this.element.value:parseFloat(this.element.value)),this.updateCaps(),this.onEnter())}),this.valueTypeIsString||this.setCap(),this.name.toLowerCase().includes("resolution")&&1!==siteSettings.resolutionMultiplier&&setTimeout(()=>this.onInput())}inputCallback(){this.disabled||(this.value=this.valueTypeIsString?this.element.value||this.defaultValue:parseFloat(this.element.value||this.defaultValue),this.valueTypeIsString||(this.value>this.maxValue&&!uncapEverything?this.value=this.maxValue:this.value<this.minValue&&!uncapEverything?this.value=this.minValue:(this.element.parentNode.classList.remove("capped-input-max"),this.element.parentNode.classList.remove("capped-input-min"))),this.onInput())}updateCaps(){this.valueTypeIsString||uncapEverything||(this.value>=this.maxValue?(this.value=this.maxValue,this.element.value=this.value,this.element.parentNode.classList.remove("capped-input-min"),this.element.parentNode.classList.add("capped-input-max")):this.value<=this.minValue?(this.value=this.minValue,this.element.value=this.value,this.element.parentNode.classList.remove("capped-input-max"),this.element.parentNode.classList.add("capped-input-min")):(this.element.parentNode.classList.remove("capped-input-max"),this.element.parentNode.classList.remove("capped-input-min")))}setValue(newValue,callOnInput=!1){this.value=newValue,this.element.value=this.value,callOnInput&&this.inputCallback()}setCap(){var e=this.element.nextElementSibling.innerHTML.split(" "),t=document.createElement("p");t.classList.add("body-text"),t.style.position="fixed",t.style.opacity=0,t.style.top="-100vh",t.style.width="fit-content",t.textContent="",pageElement.appendChild(t);let a=0;for(let n=0;n<e.length;n++)t.textContent=""+t.textContent+(n===a?"":" ")+e[n],100<=t.getBoundingClientRect().width&&(a=n,n--,t.textContent="");t.remove(),0===a?this.element.nextElementSibling.innerHTML=`<span style="white-space: nowrap">${e.slice(a).join(" ")}<span class="triangle">&#x25BC;</span></span>`:this.element.nextElementSibling.innerHTML=`<span>${e.slice(0,a).join(" ")}</span> <span style="white-space: nowrap">${e.slice(a).join(" ")}<span class="triangle">&#x25BC;</span></span>`,this.element.nextElementSibling.addEventListener("click",()=>{this.element.parentNode.classList.contains("capped-input-max")?(hideAllCapDialogs(),this.showCapDialog()):this.element.parentNode.classList.contains("capped-input-min")&&(hideAllCapDialogs(),this.showCapDialog(!0))});var i=(e=>{e.target.classList.contains("keep-dialog-open")||hideAllCapDialogs()}).bind(this);addTemporaryListener({object:document.documentElement,event:"pointerdown",callback:i})}showCapDialog(tooSmall=!1){const t=document.createElement("div");t.classList.add("input-cap-dialog"),t.classList.add("keep-dialog-open"),t.style.opacity=0,t.style.transform="scale(1)",t.innerHTML=tooSmall?`Smaller values than this may cause unexpected results, break the intended functionality of the applet, or crash the tab or entire browser. Only continue if you know what you&#x2019;re doing!
			<div class="checkbox-row keep-dialog-open">
				<div class="checkbox-container keep-dialog-open" tabindex="1">
					<input type="checkbox" id="${this.element.id}-checkbox" class="uncap-inputs-checkbox keep-dialog-open">
					<div class="checkbox keep-dialog-open"></div>
				</div>
				
				<label for="${this.element.id}-checkbox" style="margin-left: 10px" class="keep-dialog-open">
					<p class="body-text checkbox-subtext keep-dialog-open"></p>
				</label>
			</div>`:`Larger values than this may take an extremely long time to compute, cause substantial lag, or crash the tab or entire browser. Only continue if you know what you&#x2019;re doing!
			<div class="checkbox-row keep-dialog-open">
				<div class="checkbox-container keep-dialog-open" tabindex="1">
					<input type="checkbox" id="${this.element.id}-checkbox" class="uncap-inputs-checkbox keep-dialog-open">
					<div class="checkbox keep-dialog-open"></div>
				</div>
				
				<label for="${this.element.id}-checkbox" style="margin-left: 10px" class="keep-dialog-open">
					<p class="body-text checkbox-subtext keep-dialog-open"></p>
				</label>
			</div>`,pageElement.appendChild(t);var e=()=>this.updateCapDialogLocation(t);addTemporaryListener({object:window,event:"resize",callback:e}),e(),t.style.transform=siteSettings.reduceMotion?"scale(1)":"scale(.95)",setTimeout(()=>{const e=new Checkbox({element:t.querySelector(".uncap-inputs-checkbox"),name:"Uncap all inputs",checked:uncapEverything,onInput:function(){(uncapEverything=e.checked)&&$$(".capped-input-max, .capped-input-min").forEach(cappedInputElement=>{cappedInputElement.classList.remove("capped-input-max"),cappedInputElement.classList.remove("capped-input-min")})}});addHoverEventWithScale({element:e.element.parentNode,scale:1.1,addBounceOnTouch:()=>!0}),anime({targets:t,opacity:1,scale:1,duration:250,easing:"easeOutQuad"})},16)}updateCapDialogLocation(dialog){var e=this.element.nextElementSibling.getBoundingClientRect(),t=dialog.getBoundingClientRect();dialog.style.top=window.scrollY+e.top+e.height+4+"px",dialog.style.left=Math.min(Math.max(e.left-(t.width+12-e.width)/2,12),window.innerWidth-12-t.width)+"px"}}function hideAllCapDialogs(){const e=$$(".input-cap-dialog");e&&anime({targets:e,opacity:0,scale:siteSettings.reduceMotion?1:.95,duration:250,easing:"easeOutQuad",complete:()=>{e.forEach(dialog=>dialog.remove())}})}export{TextBox};