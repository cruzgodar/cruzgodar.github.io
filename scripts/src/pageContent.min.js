import anime from"../anime.min.js";import{cardAnimationTime}from"./animation.min.js";import{addHoverEventWithScale}from"./hoverEvents.min.js";import{$,$$,pageElement,pageUrl}from"./main.min.js";import{siteSettings}from"./settings.min.js";import{downloadString}from"./utils.min.js";import{convertHtmlToTex}from"/build/bin/latex.min.js";const contentsSelector=".notes-title, .section-text, .heading-text";let contentsContainerElement,contentsElement,indicatorElement,contentsShown=!1,contentsAnimating=!1;function initPageContents(){const e=$(".nav-buttons");e&&(prepareContents(),window.DEBUG&&e.insertAdjacentHTML("afterend",`
			<div class="text-buttons nav-buttons contents-button-container" style="grid-template-columns: repeat(auto-fit, 88px);">
				<div class="focus-on-child" tabindex="1">
					<button class="text-button linked-text-button" type="button" tabindex="-1">Download Worksheet</button>
				</div>
			</div>
		`),e.insertAdjacentHTML("afterend",`
		<div class="text-buttons nav-buttons contents-button-container" style="grid-template-columns: repeat(auto-fit, 88px);">
			<div class="focus-on-child" tabindex="1">
				<button class="text-button linked-text-button" type="button" tabindex="-1">Contents</button>
			</div>
		</div>
	`),e.classList.add("contents-container"),setTimeout(()=>{var t=e.nextElementSibling.firstElementChild;addHoverEventWithScale({element:t,scale:1.075,addBounceOnTouch:()=>!0}),t.addEventListener("click",showContents),window.DEBUG&&(t=e.nextElementSibling.nextElementSibling.firstElementChild,addHoverEventWithScale({element:t,scale:1.075,addBounceOnTouch:()=>!0}),t.addEventListener("click",downloadWorksheet))}))}function prepareContents(){(contentsContainerElement=document.createElement("div")).id="contents-container",pageElement.appendChild(contentsContainerElement),(contentsElement=document.createElement("div")).id="contents",contentsContainerElement.append(contentsElement);for(const n of $$(contentsSelector)){var t,e=n.cloneNode(!0);e.classList.contains("heading-text")&&-1!==(t=e.textContent.indexOf(":"))&&(e.textContent=e.textContent.slice(t+2)),contentsElement.appendChild(e),e.addEventListener("click",()=>{n.scrollIntoView({behavior:"smooth",block:"center",inline:"center"}),window.innerWidth<1e3&&hideContents()}),addHoverEventWithScale({element:e,scale:1.025,addBounceOnTouch:()=>!0})}contentsContainerElement.style.opacity=0,contentsContainerElement.style.marginRight=siteSettings.reduceMotion?0:"-32px",contentsContainerElement.style.display="none",(indicatorElement=document.createElement("img")).id="contents-indicator",indicatorElement.src="/graphics/general-icons/contents-indicator.png",pageElement.appendChild(indicatorElement),addHoverEventWithScale({element:indicatorElement,scale:1.1}),indicatorElement.addEventListener("click",showContents)}async function showContents(){contentsShown||contentsAnimating||(contentsAnimating=!0,contentsShown=!0,contentsContainerElement.style.display="flex",await Promise.all([anime({targets:contentsContainerElement,opacity:1,marginRight:0,duration:cardAnimationTime,easing:"easeOutQuint"}).finished,anime({targets:indicatorElement,opacity:0,duration:cardAnimationTime,easing:"easeOutQuint"}).finished]),document.documentElement.addEventListener("click",handleClickEvent),contentsAnimating=!1)}async function hideContents(){contentsShown&&!contentsAnimating&&(contentsAnimating=!0,contentsShown=!1,document.documentElement.removeEventListener("click",handleClickEvent),await Promise.all([anime({targets:contentsContainerElement,opacity:0,marginRight:siteSettings.reduceMotion?0:"-32px",duration:cardAnimationTime,easing:"easeOutQuint"}).finished,anime({targets:indicatorElement,opacity:1,duration:cardAnimationTime,easing:"easeOutQuint"}).finished]),contentsContainerElement.style.display="none",contentsAnimating=!1)}function handleClickEvent(e){let t=e.target;for(;t!==pageElement;){if(t===contentsElement)return;t=t.parentElement}hideContents()}async function downloadWorksheet(){var t=await fetch(pageUrl+"/data.html").then(r=>r.text()),t=(new DOMParser).parseFromString(t,"text/html").querySelectorAll("div.notes-exc.notes-environment"),t=Array.from(t).map(el=>{var t=el.innerHTML,e=t.indexOf('<div class="solution">');return-1===e?t:t.slice(0,e)}).join("");let e=0;t=t.replaceAll(/<div class="notes-exc-title notes-title">.*?<\/div>/g,()=>{return(++e%2==0?"[VSPACE]\n":1!==e?"[PAGEBREAK]\n":"")+`<strong>Exercise ${e}</strong>: `}),t=convertHtmlToTex({html:t,course:"COURSE NAME",pageUrl:pageUrl,title:"Worksheet NUMBER",partnerField:!0,margin:.75,pageNumbers:!1});downloadString(t[0],"Worksheet.tex")}export{initPageContents};