import{getFloatWgsl,hsvToRgb,rgbToHex}from"../../../scripts/applets/applet.min.js";import anime from"/scripts/anime.min.js";import{AnimationFrameApplet}from"/scripts/applets/animationFrameApplet.min.js";import{changeOpacity}from"/scripts/src/animation.min.js";import{animate,sleep}from"/scripts/src/utils.min.js";import{WilsonGPU}from"/scripts/wilson.min.js";class NewtonsMethod extends AnimationFrameApplet{wilsonHidden;rootSetterElement;rootAInput;rootBInput;colorSetterElement;roots=[[0,0],[0,0],[0,0],[0,0],[0,0],[0,0],[0,0],[0,0]];colors=[[216/255,1/255,42/255],[1,139/255,56/255],[249/255,239/255,20/255],[27/255,181/255,61/255],[0,86/255,195/255],[154/255,82/255,164/255],[32/255,32/255,32/255],[155/255,92/255,15/255]];lastActiveRoot="0";numRoots=3;numIterations=100;secantProportion=0;pastBrightnessScales=[];resolution=500;resolutionHidden=50;constructor({canvas,rootSetterElement,rootAInput,rootBInput,colorSetterElement,derivativePrecision=10}){super(canvas),this.rootSetterElement=rootSetterElement,this.rootAInput=rootAInput,this.rootBInput=rootBInput,this.colorSetterElement=colorSetterElement;var t=this.createHiddenCanvas(!1),o=(this.randomizeColors(!1),`
			struct Uniforms
			{
				worldCenter: vec2f,
				worldSize: vec2f,
				numRoots: u32,
				roots: array<vec3f, 8>, // Can't use vec2f in arrays
				colors: array<vec3f, 8>,
				a: vec2f,
				brightnessScale: f32,
				secantProportion: f32,
			}
			
			@group(0) @binding(0) var<uniform> uniforms: Uniforms;
			@group(0) @binding(1) var outputTex: texture_storage_2d<rgba16float, write>;

			const derivativePrecision = ${getFloatWgsl(derivativePrecision)};
			const threshold = 0.001;
			
			@compute @workgroup_size(8, 8)
			fn main(@builtin(global_invocation_id) globalId: vec3u)
			{
				let dimensions = textureDimensions(outputTex);
				let coords = vec2u(globalId.xy);
				
				if (coords.x >= dimensions.x || coords.y >= dimensions.y)
				{
					return;
				}
				
				// Convert pixel coordinates to complex plane [-2, 2]
				let uv = (vec2f(coords) + vec2f(0.5)) / vec2f(dimensions);
				var z = (uv - 0.5) * uniforms.worldSize + uniforms.worldCenter; // Map [0, 1] to [-2, 2]

				var lastZ = vec2f(0.0, 0.0);

				for (var i = 0u; i < 200u; i++)
				{
					let temp = cmul(
						mix(
							cmul(f(z), cinv(fPrime(z))),
							cmul(f(z), cmul(z - lastZ, cinv(f(z) - f(lastZ)))),
							uniforms.secantProportion
						),
						uniforms.a + vec2f(1.0, 0.0)
					);

					lastZ = z;
					z -= temp;

					for (var j = 0u; j < uniforms.numRoots; j++)
					{
						let d0 = length(z - uniforms.roots[j].xy);

						if (d0 < threshold)
						{
							let d1 = length(lastZ - uniforms.roots[j].xy);
			
							let brightnessAdjust = (log(threshold) - log(d0)) / (log(d1) - log(d0));
							
							let brightness = 1 - (f32(i) - brightnessAdjust) / uniforms.brightnessScale;

							textureStore(outputTex, coords, vec4f(uniforms.colors[j] * brightness, 1.0));

							return;
						}
					}
				}

				textureStore(outputTex, coords, vec4f(0.0, 0.0, 0.0, 1.0));
			}

			fn cmul(z1: vec2f, z2: vec2f) -> vec2f
			{
				return vec2f(z1.x * z2.x - z1.y * z2.y, z1.x * z2.y + z1.y * z2.x);
			}

			fn cinv(z: vec2f) -> vec2f
			{
				let magnitude = z.x * z.x + z.y * z.y;
				return vec2f(z.x / magnitude, -z.y / magnitude);
			}

			fn f(z: vec2f) -> vec2f
			{
				var result = vec2f(1.0, 0.0);

				for (var i = 0u; i < uniforms.numRoots; i++)
				{
					result = cmul(result, z - uniforms.roots[i].xy);
				}

				return result;
			}

			fn fPrime(z: vec2f) -> vec2f
			{
				return 1.0 / 12.0 * derivativePrecision * (
					-f(z + vec2f(2.0 / derivativePrecision, 0.0))
					+ 8.0 * f(z + vec2f(1.0 / derivativePrecision, 0.0))
					- 8.0 * f(z - vec2f(1.0 / derivativePrecision, 0.0))
					+ f(z - vec2f(2.0 / derivativePrecision, 0.0))
				);
			}
		`),o={shader:o,uniforms:{worldCenter:[0,0],worldSize:[2,2],numRoots:this.numRoots,roots:this.roots,colors:this.colors,a:[0,0],brightnessScale:12.75,secantProportion:this.secantProportion},canvasWidth:this.resolution,worldWidth:4,minWorldWidth:1e-5,maxWorldWidth:100,minWorldHeight:1e-5,maxWorldHeight:100,useResetButton:!0,resetButtonIconPath:"/graphics/general-icons/reset.png",onResizeCanvas:()=>this.needNewFrame=!0,interactionOptions:{useForPanAndZoom:!0,onPanAndZoom:()=>this.needNewFrame=!0},draggableOptions:{draggables:{a:[0,0],0:[0,0],1:[0,0],2:[0,0],3:[0,0],4:[0,0],5:[0,0],6:[0,0],7:[0,0]},callbacks:{drag:this.onDragDraggable.bind(this),release:this.onReleaseDraggable.bind(this)}},fullscreenOptions:{onSwitch:this.switchFullscreen.bind(this),beforeSwitch:this.beforeSwitchFullscreen.bind(this),fillScreen:!0,useFullscreenButton:!0,enterFullscreenButtonIconPath:"/graphics/general-icons/enter-fullscreen.png",exitFullscreenButtonIconPath:"/graphics/general-icons/exit-fullscreen.png"}};this.wilson=new WilsonGPU(canvas,o),this.wilsonHidden=new WilsonGPU(t,{...o,canvasWidth:this.resolutionHidden});for(let s=3;s<8;s++)this.wilson.draggables[s].element.style.display="none";this.spreadRoots({doAnimation:!1}),this.colorSetterElement&&setTimeout(()=>{var t=this.colors[0];this.colorSetterElement.firstElementChild.value=rgbToHex(255*t[0],255*t[1],255*t[2])},16),this.wilson.setCurrentStateAsDefault(),this.resume()}switchMethod(instant){const o=this.secantProportion,s=0===this.secantProportion?1:0;animate(t=>{this.secantProportion=t*s+(1-t)*o,this.wilson.setUniforms({secantProportion:this.secantProportion}),this.wilsonHidden.setUniforms({secantProportion:this.secantProportion}),this.needNewFrame=!0},instant?0:1e3,"easeInOutQuad")}async addRoot(){var t,o,s;8!==this.numRoots&&(t=3*Math.random()-1.5,o=3*Math.random()-1.5,s=Math.sqrt(t*t+o*o),this.wilson.setDraggables({[this.numRoots]:[t/s*150,o/s*150]}),this.wilson.draggables[this.numRoots].element.style.opacity=0,this.wilson.draggables[this.numRoots].element.style.display="block",this.roots[this.numRoots]=[...this.wilson.draggables[this.numRoots].location],this.wilson.setUniforms({roots:this.roots}),this.wilsonHidden.setUniforms({roots:this.roots}),this.numRoots++,this.wilson.setUniforms({numRoots:this.numRoots}),this.wilsonHidden.setUniforms({numRoots:this.numRoots}),this.moveRoots({newRoots:{[this.numRoots-1]:[t,o]},easing:"cubicBezier(0, 1, 0.5, 1)",duration:1e3}).then(()=>{this.wilson.setCurrentStateAsDefault()}),changeOpacity({element:this.wilson.draggables[this.numRoots-1].element,opacity:1,duration:1e3}),this.onReleaseDraggable({id:""+(this.numRoots-1)}),this.needNewFrame=!0)}async removeRoot(){var t,o;1!==this.numRoots&&(this.numRoots--,this.onReleaseDraggable({id:""+this.numRoots}),[t,o]=this.wilson.draggables[this.numRoots].location,o=[t/(t=Math.sqrt(t*t+o*o))*1e3,o/t*1e3],changeOpacity({element:this.wilson.draggables[this.numRoots].element,opacity:0,duration:1e3}),await this.moveRoots({newRoots:{[this.numRoots]:o},easing:"cubicBezier(1, 0, 1, 0.5)",duration:1e3}),this.wilson.draggables[this.numRoots].element.style.display="none",this.wilson.setUniforms({numRoots:this.numRoots}),this.wilsonHidden.setUniforms({numRoots:this.numRoots}),this.needNewFrame=!0)}spreadRoots({doAnimation=!0,randomize=!1}){var t={};for(let s=0;s<8;s++){var o=1+.75*randomize*Math.random();t[s]=[o*Math.cos(2*Math.PI*s/this.numRoots),o*Math.sin(2*Math.PI*s/this.numRoots)]}this.moveRoots({newRoots:t,doAnimation:doAnimation})}async moveRoots({newRoots,doAnimation=!0,easing="easeInOutQuad",duration=1e3}){const i=Object.fromEntries(Object.entries(this.wilson.draggables).map(([id,draggable])=>[id,draggable.location]));await animate(t=>{for(const e of Object.keys(newRoots)){var o=i[e],s=newRoots[e],o=[(1-t)*o[0]+t*s[0],(1-t)*o[1]+t*s[1]];this.wilson.setDraggables({[e]:o}),this.roots[e]=o}this.wilson.setUniforms({roots:this.roots}),this.wilsonHidden.setUniforms({roots:this.roots}),this.needNewFrame=!0},doAnimation?duration:0,easing)}setRoot(x,y){this.wilson.setDraggables({[this.lastActiveRoot]:[x,y]}),"a"===this.lastActiveRoot?(this.a=[x,y],this.wilson.setUniforms({a:this.a}),this.wilsonHidden.setUniforms({a:this.a})):(this.roots[this.lastActiveRoot]=[x,y],this.wilson.setUniforms({roots:this.roots}),this.wilsonHidden.setUniforms({roots:this.roots})),this.needNewFrame=!0}setColor({rgb,root=this.lastActiveRoot,animate=!0}){if(root in this.colors){const t=rgb[0]/255,o=rgb[1]/255,s=rgb[2]/255,e={r:this.colors[root][0],g:this.colors[root][1],b:this.colors[root][2]};anime({targets:e,r:t,g:o,b:s,easing:"easeInOutQuad",duration:animate?250:0,update:()=>{this.colors[root][0]=e.r,this.colors[root][1]=e.g,this.colors[root][2]=e.b,this.wilson.setUniforms({colors:this.colors}),this.wilsonHidden.setUniforms({colors:this.colors}),this.needNewFrame=!0},complete:()=>{this.colors[root][0]=t,this.colors[root][1]=o,this.colors[root][2]=s,this.wilson.setUniforms({colors:this.colors}),this.wilsonHidden.setUniforms({colors:this.colors}),this.needNewFrame=!0}})}}randomizeColors(animate=!0){for(let o=0;o<this.numRoots;o++){var t=hsvToRgb((.55*Math.random()+.525)%1,.2*Math.random()+.3,.2*Math.random()+.8);this.setColor({rgb:t,root:o,animate:animate})}}onDragDraggable({id,x,y}){"a"===id?(this.a=[x,y],this.wilson.setUniforms({a:this.a}),this.wilsonHidden.setUniforms({a:this.a})):(this.roots[id]=[x,y],this.wilson.setUniforms({roots:this.roots}),this.wilsonHidden.setUniforms({roots:this.roots})),this.needNewFrame=!0}onReleaseDraggable({id}){var t;this.lastActiveRoot=id,this.rootSetterElement&&this.colorSetterElement&&(this.updateRootSetterValues(),this.lastActiveRoot in this.colors)&&(t=this.colors[this.lastActiveRoot],this.colorSetterElement.firstElementChild.value=rgbToHex(255*t[0],255*t[1],255*t[2]))}updateRootSetterValues(){this.rootSetterElement&&this.colorSetterElement&&(this.rootAInput.setValue(Math.round(1e3*this.wilson.draggables[this.lastActiveRoot].location[0])/1e3,!1),this.rootBInput.setValue(Math.round(1e3*this.wilson.draggables[this.lastActiveRoot].location[1])/1e3,!1))}async drawFrame(){this.updateRootSetterValues(),this.wilsonHidden.setUniforms({worldSize:[this.wilson.worldWidth,this.wilson.worldHeight],worldCenter:[this.wilson.worldCenterX,this.wilson.worldCenterY]}),this.wilsonHidden.drawFrame();var t=await this.wilsonHidden.readPixels(),o=new Array(this.resolutionHidden*this.resolutionHidden);for(let i=0;i<this.resolutionHidden*this.resolutionHidden;i++)o[i]=Math.max(Math.max(t[4*i],t[4*i+1]),t[4*i+2]);o.sort((a,b)=>a-b),console.log(o[Math.floor(this.resolutionHidden*this.resolutionHidden*.96)]+o[Math.floor(this.resolutionHidden*this.resolutionHidden*.98)]);let s=Math.min(2/(o[Math.floor(this.resolutionHidden*this.resolutionHidden*.96)]+o[Math.floor(this.resolutionHidden*this.resolutionHidden*.98)]),35);this.pastBrightnessScales.push(s);var e=this.pastBrightnessScales.length;10<e&&this.pastBrightnessScales.shift();for(let n=s=0;n<this.pastBrightnessScales.length;n++)s+=this.pastBrightnessScales[n];s=Math.max(s/e,.5),this.wilson.setUniforms({worldSize:[this.wilson.worldWidth,this.wilson.worldHeight],worldCenter:[this.wilson.worldCenterX,this.wilson.worldCenterY],brightnessScale:s}),this.wilson.drawFrame()}switchFullscreen(){this.resume()}async beforeSwitchFullscreen(){this.animationPaused=!0,await sleep(33)}}export{NewtonsMethod};